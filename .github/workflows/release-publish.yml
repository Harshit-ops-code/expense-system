name: Release â€” Build & Publish Images

on:
  release:
    types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build & push backend to GHCR
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/expense-system-backend
          TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "Building ${IMAGE}:${TAG}"
          docker build --file backend/Dockerfile -t ${IMAGE}:${TAG} -t ${IMAGE}:latest .
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker push ${IMAGE}:${TAG}
          docker push ${IMAGE}:latest

      - name: Build & push frontend to GHCR
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/expense-system-frontend
          TAG: ${{ github.event.release.tag_name }}
        run: |
          echo "Building ${IMAGE}:${TAG}"
          docker build --file frontend/Dockerfile -t ${IMAGE}:${TAG} -t ${IMAGE}:latest .
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
          docker push ${IMAGE}:${TAG}
          docker push ${IMAGE}:latest

      - name: Optionally push to Docker Hub
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
          docker build --file backend/Dockerfile -t $DOCKERHUB_USERNAME/expense-system-backend:$TAG -t $DOCKERHUB_USERNAME/expense-system-backend:latest .
          docker push $DOCKERHUB_USERNAME/expense-system-backend:$TAG
          docker push $DOCKERHUB_USERNAME/expense-system-backend:latest
          docker build --file frontend/Dockerfile -t $DOCKERHUB_USERNAME/expense-system-frontend:$TAG -t $DOCKERHUB_USERNAME/expense-system-frontend:latest .
          docker push $DOCKERHUB_USERNAME/expense-system-frontend:$TAG
          docker push $DOCKERHUB_USERNAME/expense-system-frontend:latest
